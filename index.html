<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* NEW Style for menu buttons on the main grid */
        .main-menu-card {
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            position: relative; /* For image upload button positioning */
        }
        .main-menu-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .menu-name {
            font-weight: 600;
            font-size: 0.9rem;
            line-height: 1.1;
            margin-bottom: 0.25rem;
        }
        .menu-price-tag {
            font-weight: 700;
            font-size: 0.8rem;
        }

        /* Style for Category Toggle Buttons */
        .category-toggle-btn {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            font-weight: bold;
            color: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: opacity 0.3s;
            margin-bottom: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        
        /* Style for container that holds menu items */
        .menu-container-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr)); /* Use grid for sub-menus */
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        /* QR Image Container Style */
        .qr-image-container {
            width: 256px;
            height: 256px;
            margin: 0 auto;
        }
        
        /* Image Placeholder Style */
        .menu-image {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        /* Image Upload Button Style (Overlay) */
        .upload-img-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 8px;
            border-radius: 50%;
            font-size: 0.75rem;
            z-index: 10;
            cursor: pointer;
            display: none; /* Hidden by default, shown by JS */
        }
        .main-menu-card:hover .upload-img-btn {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-teal-600">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h1>
            <p class="text-gray-500">‡πÉ‡∏ä‡πâ Firebase Firestore ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏ö‡∏ö Realtime</p>
        </header>
        
        <div class="flex justify-end mb-4">
            <button id="owner-login-btn" onclick="showOwnerLogin()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-300">
                üë§ Login (Owner)
            </button>
            <button id="owner-logout-btn" onclick="firebase.auth().signOut()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition duration-300 hidden">
                üö™ Logout
            </button>
        </div>
        <div id="sales-dashboard-container" class="bg-white p-6 rounded-2xl shadow-lg mb-8" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-4">
                <div class="bg-blue-50 p-4 rounded-xl">
                    <p class="text-sm text-blue-600 font-medium">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p id="sales-today" class="text-3xl font-bold text-blue-800">‡∏ø0</p>
                </div>
                <div class="bg-green-50 p-4 rounded-xl">
                    <p class="text-sm text-green-600 font-medium">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</p>
                    <p id="sales-week" class="text-3xl font-bold text-green-800">‡∏ø0</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl">
                    <p class="text-sm text-purple-600 font-medium">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p id="sales-month" class="text-3xl font-bold text-purple-800">‡∏ø0</p>
                </div>
            </div>
            
            <button onclick="showMenuReport()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                ‚≠ê ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ
            </button>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</h2>
                
                <div id="menu-grid" class="h-[60vh] overflow-y-auto no-scrollbar pr-2 space-y-3">
                    </div>
            </div>

            <div class="flex flex-col gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg flex-grow flex flex-col">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
                    <div id="current-order-items" class="flex-grow space-y-2 overflow-y-auto no-scrollbar pr-2 mb-4 min-h-[150px]">
                        <p class="text-gray-400 text-center mt-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="delivery-address" class="block text-sm font-medium text-gray-700 mb-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á (‡∏´‡∏≤‡∏Å‡∏°‡∏µ, ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á)</label>
                        <textarea id="delivery-address" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label for="order-notes" class="block text-sm font-medium text-gray-700 mb-1">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°/‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡πÅ‡∏Å‡πâ‡∏ß, ‡πÄ‡∏ú‡πá‡∏î‡∏ô‡πâ‡∏≠‡∏¢)</label>
                        <textarea id="order-notes" rows="2" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ"></textarea>
                    </div>
                    
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center text-xl font-bold mb-4">
                            <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
                            <span id="total-price" class="text-teal-600">‡∏ø0</span>
                        </div>
                        <button id="submit-order-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:bg-gray-300">
                            ‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
                    <div id="order-queue" class="space-y-4 h-[25vh] overflow-y-auto no-scrollbar pr-2">
                            <p class="text-gray-400 text-center mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏à‡∏≤‡∏Å Firebase...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-8 shadow-xl text-center">
            <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h3 class="text-2xl font-semibold mb-2">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
            <p class="text-gray-600" id="modal-message"></p>
        </div>
    </div>

    <div id="menu-report-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl w-11/12 max-w-2xl">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-semibold text-teal-600">‚≠ê ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ</h3>
                <button onclick="document.getElementById('menu-report-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="menu-report-content" class="h-96 overflow-y-auto">
                </div>
        </div>
    </div>
    
    <div id="qr-payment-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-8 shadow-xl text-center w-11/12 max-w-sm">
            <h3 class="text-2xl font-bold text-teal-600 mb-2">Krungthai THAI QR PAYMENT</h3>
            <p class="text-xl font-medium text-gray-800 mb-3">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: <span id="qr-total-amount" class="text-red-600 font-extrabold">‡∏ø0</span></p>
            
            <div class="flex justify-center flex-col items-center p-2 bg-white border border-gray-100 rounded-xl shadow-lg mb-4">
                
                <div class="qr-image-container my-4">
                    <img src="https://raw.githubusercontent.com/khamphi880-boop/Order-Menu/c9af72f12e59972d1bed7b54fc7ab6831bd56952/176464.jpg" 
                            alt="Krungthai PromptPay QR Code" 
                            class="w-full h-full object-contain mx-auto">
                </div>
                
                <div class="w-full p-2 border-t pt-2">
                    <p class="text-base text-gray-700 font-semibold">
                        ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <span class="font-bold text-gray-900">‡∏ô.‡∏™.‡∏ô‡∏§‡∏ï‡∏ç‡∏≤ ‡∏ô‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡πå</span>
                    </p>
                </div>
            </div>

            <p class="text-sm text-red-500 mt-2">
                *‡∏¢‡∏≠‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô)
            </p>

            <button onclick="sendLineMessage(true)" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.882 13.791 9 14.271 9 14.75c0 1.282-.622 2.45-1.608 3.018l-3.376 1.948A2.5 2.5 0 011 19.5V4.5a2.5 2.5 0 014.016-1.948l3.376 1.948A4.5 4.5 0 019 9.25c0 .479-.118.958-.316 1.407M16 12a4 4 0 100-8 4 4 0 000 8zM18 16a4 4 0 100-8 4 4 0 000 8z"></path></svg>
                <span>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Line ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
            </button>
            
            <button onclick="document.getElementById('qr-payment-modal').classList.add('hidden')" class="mt-3 w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 rounded-lg">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            </button>
        </div>
    </div>
    
    <div id="image-upload-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl w-11/12 max-w-sm">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-xl font-bold text-indigo-600">üñºÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏°‡∏ô‡∏π</h3>
                <button onclick="document.getElementById('image-upload-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <p class="text-gray-700 mb-4" id="upload-menu-name">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π: **[‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π]**</p>
            <div class="p-4 bg-yellow-50 rounded-lg text-sm mb-4">
                **üí° ‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î (Spark Plan):** ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Firebase Storage ‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô Blaze)
            </div>
            
            <label for="menu-image-url" class="block text-sm font-medium text-gray-700 mb-1">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏∑‡πà‡∏ô):</label>
            <input type="text" id="menu-image-url" placeholder="Paste image URL here" class="w-full mb-4 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500">
            
            <button onclick="saveImageUrlToMenu()" id="save-url-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition duration-300">
                üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            </button>
        </div>
    </div>
    
    <div id="owner-login-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 shadow-xl w-11/12 max-w-sm">
            <h3 class="text-xl font-bold text-indigo-600 mb-4">üîë ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô)</h3>
            <input type="email" id="owner-email" placeholder="Email" class="w-full mb-3 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500">
            <input type="password" id="owner-password" placeholder="Password" class="w-full mb-4 p-2 border border-gray-300 rounded-lg focus:ring-indigo-500">
            <button onclick="ownerLogin()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 rounded-lg transition duration-300">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </button>
            <button onclick="document.getElementById('owner-login-modal').classList.add('hidden')" class="mt-3 w-full text-sm text-gray-500 hover:text-gray-700">
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>

    <audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-small-bell-notification-860.mp3" preload="auto"></audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // 2. ‡πÇ‡∏Ñ‡πâ‡∏î Configuration ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°) 
        const firebaseConfig = {
            apiKey: "AIzaSyDztPWzAu8Lz8olg_dhlCLBQVEyjTQqpOk", 
            authDomain: "ordermanagement-f6724.firebaseapp.com", 
            projectId: "ordermanagement-f6724", 
            storageBucket: "ordermanagement-f6724.appspot.com", 
            messagingSenderId: "321286666597",
            appId: "1:321286666597:web:062fef7df8fc456fec098c",
        };

        // 3. Initialize App ‡πÅ‡∏•‡∏∞ Firestore
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); // NEW: Auth service
        
        // ====================================================================
        // üìù START: ‡πÇ‡∏Ñ‡πâ‡∏î JavaScript ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Firebase) üìù
        // ====================================================================

        // *** Menu Data (Full lists) *** (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
        const menuData = [
            { id: 1, name: '‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å', prices: { '16 Oz.': 30, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45 } },
            { id: 2, name: '‡πÅ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏•‡∏π‡∏õ', prices: { '16 Oz.': 30, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45 } },
            { id: 3, name: '‡∏ô‡∏°‡∏™‡∏î', prices: { '16 Oz.': 30, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45 } },
            { id: 4, name: '‡∏ô‡∏°‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á', prices: { '16 Oz.': 30, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45 } },
            { id: 5, name: '‡∏ô‡∏°‡∏ß‡∏≤‡∏ô‡∏¥‡∏•‡∏•‡∏≤', prices: { '16 Oz.': 30, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45 } },
            { id: 6, name: '‡∏ô‡∏°‡∏Ñ‡∏≤‡∏£‡∏≤‡πÄ‡∏°‡∏•', prices: { '16 Oz.': 30, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45 } },
            { id: 7, name: '‡∏ô‡∏°‡πÄ‡∏¢‡πá‡∏ô/‡∏ô‡∏°‡∏ä‡∏°‡∏û‡∏π', prices: { '16 Oz.': 30, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45 } },
            { id: 8, name: '‡∏ô‡∏°‡∏ö‡∏£‡∏≤‡∏ß‡∏ô‡πå‡∏ä‡∏π‡∏Å‡∏≤‡∏£‡πå', prices: { '16 Oz.': 30, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45 } },
            { id: 9, name: '‡∏ô‡∏°‡∏™‡∏î ‡∏á‡∏≤‡∏î‡∏≥', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
            { id: 10, name: '‡∏ô‡∏°‡∏°‡∏¥‡πâ‡∏ô‡∏ó‡πå', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
            { id: 11, name: '‡πÇ‡∏Å‡πÇ‡∏Å‡πâ', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
            { id: 12, name: '‡∏ô‡∏°‡∏°‡∏¥‡πâ‡∏ô‡∏ó‡πå‡πÇ‡∏Å‡πÇ‡∏Å‡πâ', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
            { id: 13, name: '‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï', prices: { '16 Oz.': 40, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: 14, name: '‡∏ô‡∏°‡∏°‡∏¥‡πâ‡∏ô‡∏ó‡πå‡∏ä‡πá‡∏≠‡∏Å', prices: { '16 Oz.': 40, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: 15, name: '‡∏ô‡∏°‡∏™‡∏î‡πÇ‡∏≠‡∏£‡∏¥‡πÇ‡∏≠‡πâ', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: 16, name: '‡∏ô‡∏°‡∏Å‡∏•‡πâ‡∏ß‡∏¢', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: 17, name: '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡∏ä‡πá‡∏≠‡∏Å', prices: { '16 Oz.': 40, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: 18, name: '‡∏Å‡∏•‡πâ‡∏ß‡∏¢‡πÇ‡∏Å‡πÇ‡∏Å‡πâ', prices: { '16 Oz.': 40, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: 19, name: '‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß‡∏ô‡∏°‡∏™‡∏î', prices: { '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 55 } },
            { id: 20, name: '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢ (‡πÑ‡∏ï‡πâ‡∏´‡∏ß‡∏±‡∏ô)', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
            { id: 21, name: '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢ (‡πÉ‡∏ö‡∏ä‡∏≤)', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
            { id: 22, name: '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß', prices: { '16 Oz.': 45, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: 23, name: '‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏°‡∏∞‡∏•‡∏¥)', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
            { id: 24, name: '‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß', prices: { '16 Oz.': 45, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: 25, name: '‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
            { id: 26, name: '‡∏ä‡∏≤‡∏°‡∏∞‡∏ô‡∏≤‡∏ß', prices: { '16 Oz.': 30, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45 } },
            { id: 27, name: '‡∏ä‡∏≤‡∏û‡∏µ‡∏ä', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
            { id: 28, name: '‡∏ä‡∏≤‡∏°‡∏∞‡∏•‡∏¥', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
            { id: 29, name: '‡∏ä‡∏≤‡∏•‡∏¥‡πâ‡∏ô‡∏à‡∏µ‡πà', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
        ];
        
        const matchaMenuData = [
            { id: -1, name: '‡πÄ‡∏û‡∏µ‡∏¢‡∏ß‡∏°‡∏±‡∏ó‡∏â‡∏∞', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40 } },
            { id: -2, name: '‡πÄ‡∏û‡∏µ‡∏¢‡∏ß‡∏°‡∏±‡∏ó‡∏â‡∏∞ ‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40 } },
            { id: -3, name: '‡πÄ‡∏û‡∏µ‡∏¢‡∏ß‡∏°‡∏±‡∏ó‡∏â‡∏∞ ‡∏ß‡∏≤‡∏ô‡∏¥‡∏•‡∏•‡∏≤', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40 } },
            { id: -4, name: '‡πÄ‡∏û‡∏µ‡∏¢‡∏ß‡∏°‡∏±‡∏ó‡∏â‡∏∞ ‡∏Ñ‡∏≤‡∏£‡∏≤‡πÄ‡∏°‡∏•', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40 } },
            { id: -5, name: '‡πÄ‡∏û‡∏µ‡∏¢‡∏ß‡∏°‡∏±‡∏ó‡∏â‡∏∞ ‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 60 } },
            { id: -6, name: '‡πÄ‡∏û‡∏µ‡∏¢‡∏ß‡∏°‡∏±‡∏ó‡∏â‡∏∞ ‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 60 } },
            { id: -7, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: -8, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡πÇ‡∏≠‡∏£‡∏¥‡πÇ‡∏≠‡πâ', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 65, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 70 } },
            { id: -9, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏Ñ‡∏≤‡∏£‡∏≤‡πÄ‡∏°‡∏•', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 60, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -10, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß‡∏™‡∏î', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 65, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 70 } },
            { id: -11, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏ß‡∏≤‡∏ô‡∏¥‡∏•‡∏•‡∏≤', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 60, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -12, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏™‡∏ï‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 65, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 70 } },
            { id: -13, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏ö‡∏•‡∏π‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 65, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 70 } },
            { id: -14, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 60, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -15, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞ ‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 60, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 70 } },
            { id: -16, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏Ñ‡∏≠‡∏ü‡∏ü‡∏µ‡πà', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 60, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 70 } },
            { id: -17, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏ñ‡∏±‡πà‡∏ß‡πÅ‡∏î‡∏á', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 65, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 70 } },
            { id: -18, name: '‡∏°‡∏±‡∏ó‡∏â‡∏∞ ‡∏ñ‡∏±‡πà‡∏ß‡πÅ‡∏î‡∏á (‡∏õ‡∏±‡πà‡∏ô)', prices: { '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 70 } },
        ];
        
        const coffeeMenuData = [
            { id: -101, name: '‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 45, '‡∏õ‡∏±‡πà‡∏ô': 55 } },
            { id: -102, name: '‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà ‡∏ô‡πâ‡∏≥‡∏ú‡∏∂‡πâ‡∏á', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 50, '‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: -103, name: '‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà ‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -104, name: '‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô‡πà ‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -105, name: '‡πÄ‡∏≠‡∏™‡πÄ‡∏õ‡∏£‡∏™‡πÇ‡∏ã‡πà', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -106, name: '‡∏•‡∏≤‡πÄ‡∏ï‡πâ', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -107, name: '‡∏•‡∏≤‡πÄ‡∏ï‡πâ ‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß ‡∏ô‡∏°‡∏™‡∏î', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -108, name: '‡∏ß‡∏≤‡∏ô‡∏¥‡∏•‡∏•‡∏≤ ‡∏•‡∏≤‡πÄ‡∏ï‡πâ', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -109, name: '‡∏Ñ‡∏≤‡∏õ‡∏π‡∏ä‡∏¥‡πÇ‡∏ô‡πà', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -110, name: '‡∏°‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -111, name: '‡∏Ñ‡∏≤‡∏£‡∏≤‡πÄ‡∏°‡∏• ‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏¥‡∏≠‡∏≤‡πÇ‡∏ï‡πâ', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -112, name: '‡πÄ‡∏Æ‡πÄ‡∏ã‡∏•‡∏ô‡∏±‡∏ó ‡∏•‡∏≤‡πÄ‡∏ï‡πâ', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -113, name: '‡∏°‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤ ‡∏°‡∏¥‡πâ‡∏ô‡∏ó‡πå', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -114, name: '‡πÑ‡∏ß‡∏ó‡πå‡∏ä‡πá‡∏≠‡∏Å ‡∏°‡∏≠‡∏Ñ‡∏Ñ‡πà‡∏≤', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -115, name: '‡∏Ñ‡∏≤‡∏£‡∏≤‡πÄ‡∏°‡∏• ‡πÄ‡∏Æ‡πÄ‡∏ã‡∏•‡∏ô‡∏±‡∏ó ‡∏•‡∏≤‡πÄ‡∏ï‡πâ', prices: { '‡πÄ‡∏¢‡πá‡∏ô': 55, '‡∏õ‡∏±‡πà‡∏ô': 65 } },
        ];
        
        const fruitSmoothieData = [
            { id: -201, name: '‡∏ô‡∏°‡∏™‡∏î ‡∏Å‡∏µ‡∏ß‡∏µ‡πà', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 55 } },
            { id: -202, name: '‡∏ô‡∏°‡∏™‡∏î ‡∏™‡∏ï‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 55 } },
            { id: -203, name: '‡∏™‡∏ï‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà ‡∏ä‡πá‡∏≠‡∏Å', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 65, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 70 } },
            { id: -204, name: '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏™‡∏ï‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 65, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 70 } },
            { id: -205, name: '‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡∏™‡∏ï‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 65, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 70 } },
            { id: -206, name: '‡πÇ‡∏Å‡πÇ‡∏Å‡πâ ‡∏™‡∏ï‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: -207, name: '‡∏ä‡πá‡∏≠‡∏Å ‡∏™‡∏ï‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 50, '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 55, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 60, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -208, name: '‡∏ô‡∏°‡∏™‡∏î ‡∏ö‡∏•‡∏π‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: -209, name: '‡∏ö‡∏•‡∏π‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà ‡∏ä‡πá‡∏≠‡∏Å', prices: { '16 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 55, '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 65, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 70 } },
        ];

        const smoothieYogurtData = [
            { id: -301, name: '‡∏Å‡∏µ‡∏ß‡∏µ‡πà', prices: { '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: -302, name: '‡∏™‡∏ï‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', prices: { '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: -303, name: '‡∏û‡∏µ‡∏ä', prices: { '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: -304, name: '‡∏ö‡∏•‡∏π‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', prices: { '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 55, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -305, name: '‡∏°‡∏¥‡∏Å‡∏ã‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà', prices: { '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 55, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -306, name: '‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï ‡∏õ‡∏µ‡πÇ‡∏õ‡πâ', prices: { '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
            { id: -307, name: '‡∏•‡∏¥‡πâ‡∏ô‡∏à‡∏µ‡πà', prices: { '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 55, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 65 } },
            { id: -308, name: '‡∏™‡πâ‡∏°', prices: { '16 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 60 } },
        ];

        // ‡∏£‡∏ß‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const allMenuData = [...menuData, ...matchaMenuData, ...coffeeMenuData, ...fruitSmoothieData, ...smoothieYogurtData];
        const sweetnessOptions = ['100%', '75%', '50%', '25%'];

        // üî• Firebase Global Variables üî•
        let currentOrder = [];
        let orderQueue = []; 
        let menuSalesLog = []; 
        let currentMenuDoc = null; 

        const menuGrid = document.getElementById('menu-grid');
        const currentOrderItemsEl = document.getElementById('current-order-items');
        const totalPriceEl = document.getElementById('total-price');
        const submitOrderBtn = document.getElementById('submit-order-btn');
        const orderQueueEl = document.getElementById('order-queue');
        
        // --- UPDATED INPUTS ---
        const deliveryAddressInput = document.getElementById('delivery-address'); 
        const orderNotesInput = document.getElementById('order-notes'); 
        // ----------------------

        const salesDashboardContainer = document.getElementById('sales-dashboard-container'); 
        const salesTodayEl = document.getElementById('sales-today');
        const salesWeekEl = document.getElementById('sales-week');
        const salesMonthEl = document.getElementById('sales-month');
        const menuReportModal = document.getElementById('menu-report-modal');
        const menuReportContent = document.getElementById('menu-report-content');
        const qrPaymentModal = document.getElementById('qr-payment-modal');
        const qrTotalAmountEl = document.getElementById('qr-total-amount');
        
        // --- CUSTOMIZABLE LINE LINK (UPDATED) ---
        // ** Line Link ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ **
        const LINE_LINK = 'https://line.me/ti/p/Fr9VYI-T7F'; 

        let lastCommittedOrder = null;
        let isOwnerLoggedIn = false; 
        let orderSourceTag = ''; 
        
        // NEW GLOBAL VARIABLES FOR NOTIFICATION
        const notificationSound = document.getElementById('notification-sound'); 
        let lastQueueLength = 0; 


        // Helper function to find item data from all menus (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        function getItemDataById(itemId) {
            return allMenuData.find(i => i.id === itemId);
        }

        // NEW FUNCTION: Extract parameter from URL (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        function getURLParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name) || ''; 
        }
        
        function showPaymentQRModal(orderTotal) {
            qrTotalAmountEl.textContent = `‡∏ø${orderTotal.toLocaleString('th-TH')}`;
            qrPaymentModal.classList.remove('hidden');
        }
        
        /**
         * Generates the Line message and opens the chat window.
         * * ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Line ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
         */
        function sendLineMessage(openChat = false, manualContactInfo = null, manualAddress = null, manualTotal = null, manualNotes = null) {
            // NOTE: contactInfo ‡∏ñ‡∏π‡∏Å hardcode ‡πÄ‡∏õ‡πá‡∏ô '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' ‡πÉ‡∏ô submit handler
            const contactInfo = manualContactInfo !== null ? manualContactInfo : '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠'; 

            const data = lastCommittedOrder || { 
                id: 'PENDING',
                items: currentOrder,
                total: manualTotal !== null ? manualTotal : currentOrder.reduce((sum, item) => sum + item.price * item.quantity, 0),
                contactInfo: contactInfo,
                address: manualAddress !== null ? manualAddress : (deliveryAddressInput.value.trim() || '‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô'),
                notes: manualNotes !== null ? manualNotes : orderNotesInput.value.trim()
            };
            
            const itemsSummary = data.items.map(item => 
                `${item.name} (${item.size}, ‡∏´‡∏ß‡∏≤‡∏ô ${item.sweetness}) x${item.quantity}`
            ).join(', ');
            
            // üî• EDITED TEXT HERE üî•
            const message = 
                `üêÑ *‡∏ß‡∏±‡∏ß‡∏ô‡∏°* #${data.id.substring(0, 8)}:\n` +
                `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${itemsSummary}\n` +
                `‡∏£‡∏ß‡∏°: ‡∏ø${data.total.toLocaleString('th-TH')}\n` +
                `‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${data.contactInfo}\n` +
                `‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${data.address}\n` +
                (data.notes && data.notes.trim() !== '' ? `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${data.notes}\n` : '') +
                `--- ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`; // üî• EDITED TEXT HERE üî•

            const encodedMessage = encodeURIComponent(message);
            
            // 1. URL ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Firestore (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å) - Line Link ‡πÉ‡∏´‡∏°‡πà + Message
            const firestoreLineUrl = `${LINE_LINK}?text=${encodedMessage}`;
            
            // 2. URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ‡πÉ‡∏ä‡πâ Line Link ‡πÉ‡∏´‡∏°‡πà + Message
            const customerLineSchemeUrl = `${LINE_LINK}?text=${encodedMessage}`; 
            
            if (openChat) {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å (‡πÉ‡∏ô QR Modal) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Line Link
                window.open(customerLineSchemeUrl, '_blank');
                alert("‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î '‡∏™‡πà‡∏á' ‡πÉ‡∏ô Line Chat (‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ä‡∏£‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á Line) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤");
            }
            
            // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ URL ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Firestore
            return firestoreLineUrl;
        }

        /**
         * üî• UPDATED: ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ Line/‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ üî•
         */
        function copyAndOpenLine(orderId, contactLink, buttonText) {
            const shortOrderId = `#${orderId.substring(0, 8)}`; // #c4ga3DW4
            
            // 1. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î
            const copyPromise = navigator.clipboard && navigator.clipboard.writeText
                ? navigator.clipboard.writeText(shortOrderId).then(() => {
                    console.log(`Copied Order ID: ${shortOrderId}`);
                    if (buttonText !== 'üìû ‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å') {
                        alert(`‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${shortOrderId} ‡πÅ‡∏•‡πâ‡∏ß! (‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Line)`);
                    }
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${shortOrderId} ‡πÑ‡∏î‡πâ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏î/‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á)`);
                })
                : new Promise(resolve => {
                    alert(`‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏î‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå: ${shortOrderId})`);
                    resolve();
                });

            // 2. ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Line/‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 200ms)
            copyPromise.finally(() => {
                setTimeout(() => {
                    window.open(contactLink, '_blank');
                }, 200); // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ 200ms ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡πâ Line ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            });
        }

        // --- Date Helper Functions (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() && date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
        }

        function isThisWeek(date) {
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const endOfWeek = new Date(now.setDate(now.getDate() - now.getDay() + 6));
            return date >= startOfWeek && date <= endOfWeek;
        }

        function isThisMonth(date) {
            const now = new Date();
            return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        }

        // üî• UPDATED: Firebase Realtime Listeners (‡πÄ‡∏û‡∏¥‡πà‡∏° Logic ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô) üî•
        function initFirebaseListeners() {
            db.collection("orders") 
                .orderBy("status", "asc") 
                .orderBy("placedAt", "asc") 
                .onSnapshot(snapshot => { 
                    orderQueue = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    }));
                    
                    // NEW LOGIC: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ '‡∏Ñ‡∏¥‡∏ß' ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
                    const currentQueueLength = orderQueue.filter(order => order.status === '‡∏Ñ‡∏¥‡∏ß').length;

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (lastQueueLength > 0)
                    // ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    if (lastQueueLength > 0 && currentQueueLength > lastQueueLength) {
                        if (isOwnerLoggedIn && notificationSound) {
                            notificationSound.play().catch(e => console.log('Autoplay blocked:', e));
                        }
                    }
                    
                    lastQueueLength = currentQueueLength; // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    
                    renderOrderQueue();
                }, error => {
                    console.error("Firebase Order Listener Error:", error);
                    orderQueueEl.innerHTML = '<p class="text-red-500 text-center mt-4 font-bold">‚ö†Ô∏è ERROR: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console/Rules/Index)</p>';
                });

            db.collection("salesLog").onSnapshot(snapshot => {
                menuSalesLog = snapshot.docs.map(doc => doc.data());
                updateSalesDashboard();
            }, error => {
                console.error("Firebase Sales Listener Error:", error);
            });
            
            auth.onAuthStateChanged(handleAuthChange);
        }
        
        // --- Core Application Logic (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        
        function createMenuItemButton(item, size, price, colorClass) {
            let sizeLabel = size;
            
            if (size.includes('Oz.')) {
                sizeLabel = size.replace('Oz.', ' ‡∏≠‡∏≠‡∏ô‡∏ã‡πå');
                const hasOther16Oz = item.prices['16 Oz. ‡∏õ‡∏±‡πà‡∏ô'] || item.prices['16 Oz. ‡πÄ‡∏¢‡πá‡∏ô'];
                const has22OzOptions = item.prices['22 Oz. ‡πÄ‡∏¢‡πá‡∏ô'] || item.prices['22 Oz. ‡∏õ‡∏±‡πà‡∏ô'];

                if (size === '16 Oz.' && (hasOther16Oz || has22OzOptions)) {
                    sizeLabel = '16 ‡∏≠‡∏≠‡∏ô‡∏ã‡πå ‡πÄ‡∏¢‡πá‡∏ô';
                }
                
                if (size.includes('‡πÄ‡∏¢‡πá‡∏ô')) {
                     sizeLabel = sizeLabel.replace(' ‡πÄ‡∏¢‡πá‡∏ô', ' ‡πÄ‡∏¢‡πá‡∏ô'); 
                } else if (size.includes('‡∏õ‡∏±‡πà‡∏ô')) {
                     sizeLabel = sizeLabel.replace(' ‡∏õ‡∏±‡πà‡∏ô', ' ‡∏õ‡∏±‡πà‡∏ô'); 
                }

                sizeLabel = sizeLabel.replace(/\s\s+/g, ' ').trim();
                
            }
            else if (size === '‡πÄ‡∏¢‡πá‡∏ô' || size === '‡∏õ‡∏±‡πà‡∏ô') {
                sizeLabel = size;
            }

            const menuItem = document.createElement('div');
            menuItem.className = `main-menu-card ${colorClass}`;
            menuItem.setAttribute('onclick', `addToOrder(${item.id}, '${size.replace(/'/g, "\\'")}', ${price})`);

            let imageHtml = '';
            if (item.imageUrl) {
                 imageHtml = `<img src="${item.imageUrl}" alt="${item.name} image" class="menu-image">`;
            } else {
                 imageHtml = `<div class="menu-image flex items-center justify-center text-xs text-gray-400 bg-gray-100">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>`;
            }
            
            const uploadBtnHtml = `<span class="upload-img-btn text-xs" style="display: none;" onclick="event.stopPropagation(); showImageUploadModal(${item.id}, '${item.name}', '${size.replace(/'/g, "\\'")}', ${price})">üì∑</span>`;

            menuItem.innerHTML = `
                ${uploadBtnHtml}
                ${imageHtml}
                <p class="menu-name">${item.name}</p>
                <p class="text-gray-500 text-xs">${sizeLabel}</p>
                <p class="menu-price-tag text-teal-600">‡∏ø${price.toLocaleString('th-TH')}</p>
            `;
            return menuItem;
        }

        function renderCategoryMenu(categoryName, menuData, colorClass, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            menuData.forEach(item => {
                const availableSizes = Object.keys(item.prices);
                
                availableSizes.forEach(size => {
                    const price = item.prices[size];
                    const button = createMenuItemButton(item, size, price, colorClass);
                    container.appendChild(button);
                });
            });
            
            if (isOwnerLoggedIn) {
                document.querySelectorAll('.upload-img-btn').forEach(btn => btn.style.display = 'block');
            }
        }


        function toggleCategory(containerId) {
            const container = document.getElementById(containerId);
            container.classList.toggle('hidden');
            
            const btn = document.querySelector(`#${containerId}`).previousElementSibling;
            const arrow = btn.querySelector('svg');
            arrow.classList.toggle('rotate-180');
        }

        function renderMenu() {
            menuGrid.innerHTML = ''; 
            
            const categories = [
                { title: 'ü•õ ‡∏ô‡∏°/‡∏ä‡∏≤/‡πÇ‡∏Å‡πÇ‡∏Å‡πâ (Standard)', data: menuData, color: 'bg-teal-500 hover:bg-teal-600', colorClass: 'bg-teal-50 hover:bg-teal-100', containerId: 'menu-standard' },
                { title: 'üçµ ‡πÄ‡∏°‡∏ô‡∏π‡∏°‡∏±‡∏ó‡∏â‡∏∞/‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', data: matchaMenuData, color: 'bg-emerald-500 hover:bg-emerald-600', colorClass: 'bg-emerald-50 hover:bg-emerald-100', containerId: 'menu-matcha' },
                { title: '‚òï ‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏≤‡πÅ‡∏ü (COFFEE)', data: coffeeMenuData, color: 'bg-amber-700 hover:bg-amber-800', colorClass: 'bg-amber-50 hover:bg-amber-100', containerId: 'menu-coffee' },
                { title: 'üçì ‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ‡∏ú‡∏•‡πÑ‡∏°‡πâ (Fruit)', data: fruitSmoothieData, color: 'bg-sky-500 hover:bg-sky-600', colorClass: 'bg-sky-50 hover:bg-sky-100', containerId: 'menu-fruit' },
                { title: 'üçá ‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï (Yogurt)', data: smoothieYogurtData, color: 'bg-indigo-500 hover:bg-indigo-600', colorClass: 'bg-indigo-50 hover:bg-indigo-100', containerId: 'menu-yogurt' },
            ];

            categories.forEach(category => {
                const toggleBtn = document.createElement('div');
                toggleBtn.className = `category-toggle-btn ${category.color}`;
                toggleBtn.setAttribute('onclick', `toggleCategory('${category.containerId}')`);
                toggleBtn.innerHTML = `
                    <span>${category.title}</span>
                    <svg class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                `;
                menuGrid.appendChild(toggleBtn);

                const menuContainer = document.createElement('div');
                menuContainer.id = category.containerId;
                menuContainer.className = 'menu-container-grid hidden'; 
                menuGrid.appendChild(menuContainer);

                renderCategoryMenu(category.title, category.data, category.colorClass, category.containerId);
            });
        }
        
        function addToOrder(itemId, size = null, price = null) {
            const item = getItemDataById(itemId);
            if (!item) return;

            let finalSize = size;
            let finalPrice = price;

            if (finalSize === null || finalPrice === null) {
                const defaultSize = Object.keys(item.prices)[0];
                finalSize = defaultSize;
                finalPrice = item.prices[defaultSize];
            }

            const defaultSweetness = sweetnessOptions[0];

            const orderItem = {
                id: Date.now(),
                itemId: item.id,
                name: item.name,
                size: finalSize, 
                price: finalPrice, 
                quantity: 1,
                sweetness: defaultSweetness,
            };
            
            const existingItemIndex = currentOrder.findIndex(
                i => i.itemId === itemId && i.size === finalSize && i.sweetness === defaultSweetness
            );

            if (existingItemIndex !== -1) {
                currentOrder[existingItemIndex].quantity += 1;
            } else {
                currentOrder.push(orderItem);
            }
            
            renderCurrentOrder();
        }
        
        // --- Owner Authentication Logic (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        
        function showOwnerLogin() {
            document.getElementById('owner-login-modal').classList.remove('hidden');
        }
        
        function ownerLogin() {
            const email = document.getElementById('owner-email').value;
            const password = document.getElementById('owner-password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    document.getElementById('owner-login-modal').classList.add('hidden');
                })
                .catch((error) => {
                    alert(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
                });
        }
        
        function handleAuthChange(user) {
            if (user) {
                isOwnerLoggedIn = true;
                document.getElementById('owner-login-btn').classList.add('hidden');
                document.getElementById('owner-logout-btn').classList.remove('hidden');
                
                salesDashboardContainer.style.display = 'block'; 
                document.querySelectorAll('.upload-img-btn').forEach(btn => btn.style.display = 'block');
                
                alert(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${user.email} ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô)`);
            } else {
                isOwnerLoggedIn = false;
                document.getElementById('owner-login-btn').classList.remove('hidden');
                document.getElementById('owner-logout-btn').classList.add('hidden');
                
                salesDashboardContainer.style.display = 'none'; 
                document.querySelectorAll('.upload-img-btn').forEach(btn => btn.style.display = 'none');
            }
        }
        
        function showImageUploadModal(itemId, itemName) {
            currentMenuDoc = itemId; 
            const item = getItemDataById(itemId);
            
            document.getElementById('upload-menu-name').textContent = `‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π: **${itemName}** (ID: ${itemId})`;
            document.getElementById('menu-image-url').value = item.imageUrl || ''; 
            document.getElementById('image-upload-modal').classList.remove('hidden');
        }

        function saveImageUrlToMenu() {
            if (!currentMenuDoc) return alert("Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å");
            
            const imageUrl = document.getElementById('menu-image-url').value.trim();
            
            const itemIndex = allMenuData.findIndex(item => item.id === currentMenuDoc);
            if (itemIndex === -1) {
                alert("Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
                return;
            }
            
            allMenuData[itemIndex].imageUrl = imageUrl;
            
            renderMenu(); 
            
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Firestore)");
            document.getElementById('image-upload-modal').classList.add('hidden');
        }
        
        // --- Core Order Rendering Logic (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---

        function renderCurrentOrder() {
            if (currentOrder.length === 0) {
                currentOrderItemsEl.innerHTML = '<p class="text-gray-400 text-center mt-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°...</p>';
                submitOrderBtn.disabled = true;
            } else {
                currentOrderItemsEl.innerHTML = '';
                currentOrder.forEach(item => {
                    const menuItem = getItemDataById(item.itemId);
                    const availableSizes = Object.keys(menuItem.prices);

                    const sizeOptions = availableSizes.map(size => `<option value="${size}" ${item.size === size ? 'selected' : ''}>${size}</option>`).join('');
                    const sweetnessDropdown = sweetnessOptions.map(level => `<option value="${level}" ${item.sweetness === level ? 'selected' : ''}>${level}</option>`).join('');

                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-lg';
                    itemEl.innerHTML = `
                        <div class="flex-grow grid grid-cols-2 gap-2">
                            <p class="font-semibold col-span-2">${item.name}</p>
                            <div class="flex flex-col">
                                <span class="text-xs font-medium text-gray-500 mb-1">‡∏Ç‡∏ô‡∏≤‡∏î</span>
                                <select class="text-sm p-1 border rounded" onchange="updateOrderItemSize(${item.id}, this.value)">${sizeOptions}</select>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs font-medium text-gray-500 mb-1">‡∏´‡∏ß‡∏≤‡∏ô</span>
                                <select class="text-sm p-1 border rounded" onchange="updateOrderItemSweetness(${item.id}, this.value)">${sweetnessDropdown}</select>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <button class="w-6 h-6 bg-gray-200 rounded-full" onclick="updateOrderItemQuantity(${item.id}, -1)">-</button>
                            <span>${item.quantity}</span>
                            <button class="w-6 h-6 bg-gray-200 rounded-full" onclick="updateOrderItemQuantity(${item.id}, 1)">+</button>
                        </div>
                        <span class="w-20 text-right font-semibold">‡∏ø${(item.price * item.quantity).toLocaleString('th-TH')}</span>
                        <button class="ml-2 text-red-500 hover:text-red-700" onclick="removeOrderItem(${item.id})">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    currentOrderItemsEl.appendChild(itemEl);
                });
                submitOrderBtn.disabled = false;
            }
            updateTotalPrice();
        }

        function updateOrderItemSweetness(orderItemId, newSweetness) {
            const orderItem = currentOrder.find(item => item.id === orderItemId);
            if (orderItem.sweetness !== newSweetness) {
                if (orderItem.quantity > 1) {
                    orderItem.quantity -= 1;
                    const newItem = {...orderItem, id: Date.now(), sweetness: newSweetness, quantity: 1};
                    currentOrder.push(newItem);
                } else {
                    orderItem.sweetness = newSweetness;
                }
            }
            renderCurrentOrder();
        }
        
        function updateOrderItemSize(orderItemId, newSize) {
            const orderItem = currentOrder.find(item => item.id === orderItemId);
            const menuItem = getItemDataById(orderItem.itemId);
            
            if (menuItem.prices[newSize] !== undefined) {
                if (orderItem.size !== newSize) {
                    if (orderItem.quantity > 1) {
                        orderItem.quantity -= 1;
                        const newPrice = menuItem.prices[newSize];
                        const newItem = {...orderItem, id: Date.now(), size: newSize, price: newPrice, quantity: 1};
                        currentOrder.push(newItem);
                    } else {
                        orderItem.size = newSize;
                        orderItem.price = menuItem.prices[newSize];
                    }
                }
            }
            renderCurrentOrder();
        }
        
        function updateOrderItemQuantity(orderItemId, change) {
            const orderItem = currentOrder.find(item => item.id === orderItemId);
            if (orderItem.quantity + change > 0) {
                orderItem.quantity += change;
            } else if (orderItem.quantity + change === 0) {
                removeOrderItem(orderItemId); 
                return;
            }
            renderCurrentOrder();
        }

        function removeOrderItem(orderItemId) {
            currentOrder = currentOrder.filter(item => item.id !== orderItemId);
            renderCurrentOrder();
        }

        function updateTotalPrice() {
            const total = currentOrder.reduce((sum, item) => sum + item.price * item.quantity, 0);
            totalPriceEl.textContent = `‡∏ø${total.toLocaleString('th-TH')}`;
        }


        // --- Share Summary Logic (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        function shareOrderSummary() {
            if (!lastCommittedOrder) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ä‡∏£‡πå');
                return;
            }

            const itemsText = lastCommittedOrder.items.map(item =>
                `* ${item.name} (${item.size}, ‡∏´‡∏ß‡∏≤‡∏ô ${item.sweetness}) x${item.quantity} = ‡∏ø${(item.price * item.quantity).toLocaleString('th-TH')}`
            ).join('\n');

            let notesText = '';
            if (lastCommittedOrder.notes && lastCommittedOrder.notes.trim() !== '') {
                notesText = `\nüìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${lastCommittedOrder.notes.trim()}\n`;
            }
            
            let sourceTagText = '';
            if (lastCommittedOrder.sourceTag && lastCommittedOrder.sourceTag.trim() !== '') {
                sourceTagText = `\nSource: ${lastCommittedOrder.sourceTag.trim()}`;
            }

            const shareText =
                `‚úÖ *‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏• #${lastCommittedOrder.id.substring(0, 8)} - ${new Date().toLocaleDateString('th-TH')}*\n` +
                `----------------------------------------\n` +
                `üì± ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${lastCommittedOrder.contactInfo}\n` + 
                `${itemsText}\n` +
                `----------------------------------------\n` +
                `üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${lastCommittedOrder.address}` + 
                notesText + 
                `üí∞ *‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: ‡∏ø${lastCommittedOrder.total.toLocaleString('th-TH')}*\n\n` +
                `üí¨ *[‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô] ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ QR Code ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏ö‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô*\n` +
                `‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ô.‡∏™.‡∏ô‡∏§‡∏ï‡∏ç‡∏≤ ‡∏ô‡∏≤‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏£‡∏±‡∏Å‡∏©‡πå` + 
                sourceTagText; 

            if (navigator.share) {
                navigator.share({ title: `‡∏ö‡∏¥‡∏•‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${lastCommittedOrder.id.substring(0, 8)}`, text: shareText })
                .catch((error) => {
                    navigator.clipboard.writeText(shareText)
                        .then(() => alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏• (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°) ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß!'))
                        .catch(err => console.error('Could not copy text: ', err));
                });
            } else {
                navigator.clipboard.writeText(shareText)
                    .then(() => alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏• (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°) ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß!'))
                    .catch(err => console.error('Could not copy text: ', err));
            }
        }


        // üî• UPDATED: Submit Order (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ contactInfo) üî•
        submitOrderBtn.addEventListener('click', () => {
            const orderTotal = currentOrder.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const address = deliveryAddressInput.value.trim(); 
            const notes = orderNotesInput.value.trim(); 
            
            // 1. CHECK IF CART IS EMPTY (REQUIRED)
            if (currentOrder.length === 0) {
                 alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå");
                 return; 
            }
            
            // 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î contactInfo ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
            const contactInfo = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠'; 
            
            // 3. Generate the Line Chat URL (for owner tracking)
            const contactLineURL = sendLineMessage(false, contactInfo, address || '‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô', orderTotal, notes); 
            
            // --- Proceed with submission ---
            
            db.collection("orders").add({ 
                items: currentOrder,
                total: orderTotal,
                contactInfo: contactInfo, // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠'
                contactLineURL: contactLineURL,
                address: address || '‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô',
                notes: notes, 
                status: '‡∏Ñ‡∏¥‡∏ß',
                placedAt: firebase.firestore.FieldValue.serverTimestamp(), 
                sourceTag: orderSourceTag 
            })
            .then(docRef => {
                lastCommittedOrder = {
                     id: docRef.id, 
                     items: [...currentOrder],
                     total: orderTotal,
                     contactInfo: contactInfo, 
                     address: address || '‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô',
                     notes: notes, 
                     sourceTag: orderSourceTag,
                     contactLineURL: contactLineURL 
                };
                
                // Clear inputs
                currentOrder = []; 
                deliveryAddressInput.value = '';
                orderNotesInput.value = ''; 
                
                renderCurrentOrder(); 
                showPaymentQRModal(orderTotal);
            })
            .catch(error => {
                console.error("Error adding document: ", error);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
            });
        });

        // üî• UPDATED: renderOrderQueue (‡πÉ‡∏ä‡πâ Line Official Link ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ Line) üî•
        function renderOrderQueue() {
            const displayQueue = orderQueue.filter(order => order.status !== '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' && order.status !== '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');

            if (displayQueue.length === 0) {
                orderQueueEl.innerHTML = '<p class="text-gray-400 text-center mt-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß</p>';
                return;
            }
            
            orderQueueEl.innerHTML = '';
            let queueNumber = 1; 
            
            displayQueue.forEach(order => {
                const itemsSummary = order.items.map(item => `${item.name} (${item.size}, ‡∏´‡∏ß‡∏≤‡∏ô ${item.sweetness}) x${item.quantity}`).join(', ');
                const statusColor = {
                    '‡∏Ñ‡∏¥‡∏ß': 'bg-blue-100 text-blue-800',
                    '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥': 'bg-yellow-100 text-yellow-800',
                    '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß': 'bg-green-100 text-green-800',
                    '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å': 'bg-red-100 text-red-800'
                }[order.status];
                
                const isCompleted = order.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' || order.status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                
                let actionButtonsHtml = '';
                let orderHeader = `‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${order.id.substring(0, 8)}...`;
                
                let notesDisplay = '';
                if (order.notes && order.notes.trim() !== '') {
                    notesDisplay = `<p class="text-xs text-red-600 font-semibold mt-1">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${order.notes.trim()}</p>`;
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠' ‡πÄ‡∏™‡∏°‡∏≠
                let contactDisplay = '';
                if (order.contactInfo && order.contactInfo !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠') {
                     contactDisplay = `<p class="text-xs text-gray-800 font-semibold mt-1">üì± ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: ${order.contactInfo}</p>`;
                } else {
                     contactDisplay = `<p class="text-xs text-red-500 font-semibold mt-1">üö´ ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</p>`;
                }

                let sourceTagDisplay = '';
                let lineContactButton = ''; 

                if (isOwnerLoggedIn) {
                    // OWNER VIEW: Show full header and action buttons
                    orderHeader = `‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà #${queueNumber} | ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${order.id.substring(0, 8)}...`;
                    
                    // ==========================================================
                    // NEW LOGIC: ‡∏õ‡∏∏‡πà‡∏° Line Chat ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Line OA Link
                    // ==========================================================
                    let contactLink = null;
                    let buttonText = '‡πÅ‡∏ä‡∏ó Line';
                    let buttonColor = 'bg-green-500 hover:bg-green-600';
                    let iconSvg = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>`;

                    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏≠‡∏¢‡∏π‡πà)
                    if (order.contactInfo && order.contactInfo !== '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠') {
                        const contact = order.contactInfo.trim().replace(/-/g, '');
                        if (contact.match(/^0\d{9}$/) || contact.match(/^\d{9,10}$/)) { 
                            contactLink = `tel:${contact}`;
                            buttonText = 'üìû ‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å';
                            buttonColor = 'bg-blue-500 hover:bg-blue-600';
                            iconSvg = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>`;
                        }
                    } 
                    
                    // 2. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Line OA Link ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà
                    if (!contactLink) {
                        // **‡πÉ‡∏ä‡πâ Line Link ‡πÉ‡∏´‡∏°‡πà**
                        contactLink = LINE_LINK; 
                        buttonText = '‡πÅ‡∏ä‡∏ó Line';
                    }

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ID ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î Link (‡πÉ‡∏ä‡πâ copyAndOpenLine)
                    lineContactButton = `<button onclick="copyAndOpenLine('${order.id}', '${contactLink.replace(/'/g, "\\'")}', '${buttonText.replace(/'/g, "\\'")}')" 
                                            class="text-xs ${buttonColor} text-white font-bold py-1 px-3 rounded-lg flex items-center space-x-1">
                                            ${iconSvg}
                                            <span>${buttonText}</span>
                                        </button>`;
                    
                    // Action Buttons (Accept, Done, Cancel)
                    if (order.status === '‡∏Ñ‡∏¥‡∏ß') {
                        actionButtonsHtml += `<button class="text-xs bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1 px-3 rounded-lg" onclick="updateOrderStatus('${order.id}', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥')">‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>`;
                    } else if (order.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥') {
                        actionButtonsHtml += `<button class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg" onclick="updateOrderStatus('${order.id}', '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß')">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>`;
                    }
                    if (!isCompleted) {
                         actionButtonsHtml += `<button class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg" onclick="updateOrderStatus('${order.id}', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>`;
                    }

                    if (order.sourceTag && order.sourceTag.trim() !== '') {
                        sourceTagDisplay = `<p class="text-xs text-purple-600 font-semibold mt-1">üîó ‡∏ó‡∏µ‡πà‡∏°‡∏≤: ${order.sourceTag.trim()}</p>`;
                    }
                } else {
                    // CUSTOMER VIEW: Show queue number and status info only
                    orderHeader = `‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà #${queueNumber} | ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${order.id.substring(0, 8)}...`;
                    contactDisplay = ''; // Hide contact info from general view
                }
                
                if (!isCompleted) {
                    queueNumber++;
                }

                const orderCard = document.createElement('div');
                orderCard.className = `p-4 rounded-lg shadow-sm ${isCompleted ? 'bg-gray-200 opacity-75' : 'bg-gray-50 hover:bg-white'}`;
                
                orderCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-bold text-lg text-teal-700">${orderHeader}</h4> 
                            <p class="text-sm text-gray-600">${itemsSummary}</p>
                            ${contactDisplay} 
                            <p class="text-xs text-gray-500 mt-1">
                                <span class="font-semibold">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</span> ${order.address}
                            </p>
                            ${notesDisplay}
                            ${sourceTagDisplay} 
                        </div>
                        <span class="text-lg font-bold text-teal-600">‡∏ø${order.total.toLocaleString('th-TH')}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold px-2.5 py-0.5 rounded-full ${statusColor}">${order.status}</span>
                        <div class="flex gap-2">
                            ${lineContactButton} 
                            ${actionButtonsHtml}
                        </div>
                    </div>
                `;
                orderQueueEl.appendChild(orderCard);
            });
        }
        
        // --- Sales & Report Logic (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        function updateOrderStatus(orderId, newStatus) {
            if (!isOwnerLoggedIn) {
                alert("‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò: ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô)");
                return;
            }
            
            const order = orderQueue.find(o => o.id === orderId);
            if (!order) return;

            const updateData = { status: newStatus };
            if (newStatus === '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') {
                updateData.completedAt = firebase.firestore.FieldValue.serverTimestamp();
                
                const batch = db.batch(); 
                order.items.forEach(item => {
                    const newLogRef = db.collection("salesLog").doc();
                    batch.set(newLogRef, {
                        name: item.name,
                        size: item.size,
                        sweetness: item.sweetness,
                        quantity: item.quantity,
                        price: item.price,
                        soldAt: updateData.completedAt,
                        orderId: orderId
                    });
                });
                batch.commit().then(() => {
                    console.log("Sales Log batch successfully written!");
                }).catch((error) => {
                    console.error("Error writing sales log batch: ", error);
                });
            }
            
            db.collection("orders").doc(orderId).update(updateData)
                .then(() => console.log("Order status updated!"))
                .catch(error => console.error("Error updating order: ", error));
        }

        function updateSalesDashboard() {
            let salesToday = 0;
            let salesWeek = 0;
            let salesMonth = 0;
            
            menuSalesLog.forEach(log => {
                const saleDate = log.soldAt ? new Date(log.soldAt.seconds * 1000) : new Date();
                const totalRevenue = log.price * log.quantity;

                if (isToday(saleDate)) { salesToday += totalRevenue; }
                if (isThisWeek(saleDate)) { salesWeek += totalRevenue; }
                if (isThisMonth(saleDate)) { salesMonth += totalRevenue; }
            });
            
            salesTodayEl.textContent = `‡∏ø${salesToday.toLocaleString('th-TH')}`;
            salesWeekEl.textContent = `‡∏ø${salesWeek.toLocaleString('th-TH')}`;
            salesMonthEl.textContent = `‡∏ø${salesMonth.toLocaleString('th-TH')}`;
        }

        function showMenuReport() {
            if (!isOwnerLoggedIn) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô");
                return;
            }
            
            const menuSales = {};
            
            menuSalesLog.forEach(log => {
                const key = `${log.name} (${log.size}, ‡∏´‡∏ß‡∏≤‡∏ô ${log.sweetness})`;
                if (!menuSales[key]) {
                    menuSales[key] = { name: log.name, size: log.size, sweetness: log.sweetness, totalQuantity: 0, totalRevenue: 0, };
                }
                menuSales[key].totalQuantity += log.quantity;
                menuSales[key].totalRevenue += log.price * log.quantity;
            });
            
            const sortedMenuReport = Object.values(menuSales).sort((a, b) => b.totalQuantity - a.totalQuantity);
            let tableHTML = '<p class="text-gray-500 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡∏ß‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>';
            if (sortedMenuReport.length === 0) {
                tableHTML += '<p class="text-center text-gray-400 mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</p>';
            } else {
                tableHTML += `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-teal-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏°‡∏ô‡∏π / ‡∏Ç‡∏ô‡∏≤‡∏î / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÅ‡∏Å‡πâ‡∏ß)</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (‡∏ø)</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                sortedMenuReport.forEach( (report, index) => {
                    tableHTML += `<tr class="${index < 3 ? 'bg-yellow-50 font-semibold' : ''}"><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${report.name} (${report.size}, ‡∏´‡∏ß‡∏≤‡∏ô ${report.sweetness})</td><td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">${report.totalQuantity.toLocaleString('th-TH')}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-right text-teal-600">${report.totalRevenue.toLocaleString('th-TH')}</td></tr>`;
                });
                tableHTML += '</tbody></table>';
            }
            menuReportContent.innerHTML = tableHTML;
            menuReportModal.classList.remove('hidden');
        }

        // --- Initial setup ---
        orderSourceTag = getURLParameter('source_tag'); 
        if (orderSourceTag) {
            console.log(`Order source identified: ${orderSourceTag}`);
        }
        
        renderMenu();
        renderCurrentOrder();
        initFirebaseListeners();
    </script>
</body>
</html>
