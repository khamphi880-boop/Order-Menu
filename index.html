// ====================================================================
// üî• START: FIREBASE CONNECTION AND INITIALIZATION (‡πÉ‡∏ä‡πâ CDN) üî•
// ====================================================================

// 1. ‡πÇ‡∏´‡∏•‡∏î Firebase Libraries (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå)
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script> 

<script>
    // 2. ‡πÇ‡∏Ñ‡πâ‡∏î Configuration ‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ñ‡∏∏‡∏ì (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏°‡∏≤)
    const firebaseConfig = {
        apiKey: "AIzaSyDztPWzAu8Lz8olg_dhlCLBQVEyjTQqpOk",
        authDomain: "ordermanagement-f6724.firebaseapp.com",
        projectId: "ordermanagement-f6724",
        storageBucket: "ordermanagement-f6724.appspot.com", // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô .appspot.com
        messagingSenderId: "321286666597",
        appId: "1:321286666597:web:062fef7df8fc456fec098c",
        // measurementId: "G-HKSKRWCWCX" // ‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firestore
    };

    // 3. Initialize App ‡πÅ‡∏•‡∏∞ Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // ====================================================================
    // üìù START: ‡πÇ‡∏Ñ‡πâ‡∏î JavaScript ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Firebase) üìù
    // ====================================================================

    // *** Menu Data (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ***
    const menuData = [
        { id: 1, name: '‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å', prices: { '16 Oz.': 30, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45 } },
        { id: 2, name: '‡πÅ‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏•‡∏π‡∏õ', prices: { '16 Oz.': 30, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 40, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 45 } },
        // ... (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: matchaMenuData, coffeeMenuData, etc.)
        { id: 29, name: '‡∏ä‡∏≤‡∏•‡∏¥‡πâ‡∏ô‡∏à‡∏µ‡πà', prices: { '16 Oz.': 35, '22 Oz. ‡πÄ‡∏¢‡πá‡∏ô': 45, '22 Oz. ‡∏õ‡∏±‡πà‡∏ô': 50 } },
    ];
    // (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô menuData, matchaMenuData, coffeeMenuData, fruitSmoothieData, smoothieYogurtData ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    
    const matchaMenuData = [
        // ... (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• matchaMenuData ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
    ];
    const coffeeMenuData = [
        // ... (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• coffeeMenuData ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
    ];
    const fruitSmoothieData = [
        // ... (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• fruitSmoothieData ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
    ];
    const smoothieYogurtData = [
        // ... (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• smoothieYogurtData ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
    ];


    const allMenuData = [...menuData, ...matchaMenuData, ...coffeeMenuData, ...fruitSmoothieData, ...smoothieYogurtData];
    const sweetnessOptions = ['100%', '75%', '50%', '25%'];

    // üî• ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Local Storage ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏î‡∏¢ Listener
    let currentOrder = [];
    let orderQueue = []; 
    let menuSalesLog = []; 
    let orderCounter = 1; // ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å

    const menuGrid = document.getElementById('menu-grid');
    const currentOrderItemsEl = document.getElementById('current-order-items');
    const totalPriceEl = document.getElementById('total-price');
    const submitOrderBtn = document.getElementById('submit-order-btn');
    const orderQueueEl = document.getElementById('order-queue');
    const deliveryAddressInput = document.getElementById('delivery-address');

    const salesTodayEl = document.getElementById('sales-today');
    const salesWeekEl = document.getElementById('sales-week');
    const salesMonthEl = document.getElementById('sales-month');
    const menuReportModal = document.getElementById('menu-report-modal');
    const menuReportContent = document.getElementById('menu-report-content');
    const matchaModal = document.getElementById('matcha-modal');
    const coffeeModal = document.getElementById('coffee-modal');
    const fruitSmoothieModal = document.getElementById('fruit-smoothie-modal');
    const qrPaymentModal = document.getElementById('qr-payment-modal');
    const qrTotalAmountEl = document.getElementById('qr-total-amount');

    let lastCommittedOrder = null;

    // Helper function to find item data from all menus (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    function getItemDataById(itemId) {
        return allMenuData.find(i => i.id === itemId);
    }
    
    function showPaymentQRModal(orderTotal) {
        qrTotalAmountEl.textContent = `‡∏ø${orderTotal.toLocaleString('th-TH')}`;
        qrPaymentModal.classList.remove('hidden');
    }

    // üî• NEW: Firebase Listeners üî•
    function initFirebaseListeners() {
        // 1. Realtime Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå (orders Collection)
        db.collection("orders").orderBy("placedAt", "asc").onSnapshot(snapshot => {
            orderQueue = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data() 
            }));
            orderQueue.sort((a, b) => {
                const statusOrder = { '‡∏Ñ‡∏¥‡∏ß': 1, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥': 2, '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß': 3, '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å': 4 };
                return statusOrder[a.status] - statusOrder[b.status];
            });
            renderOrderQueue();
        }, error => {
            console.error("Error listening to orders: ", error);
        });

        // 2. Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (salesLog Collection)
        db.collection("salesLog").onSnapshot(snapshot => {
            menuSalesLog = snapshot.docs.map(doc => doc.data());
            updateSalesDashboard();
        }, error => {
            console.error("Error listening to sales log: ", error);
        });
    }

    // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Modal (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
    // (‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å renderFruitSmoothieMenu, showCoffeeMenuModal, renderCoffeeMenu, etc. ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
    
    // --- Core Application Logic (addToOrder, renderCurrentOrder, updateOrderItemSweetness, updateOrderItemSize, updateOrderItemQuantity, removeOrderItem, updateTotalPrice ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---

    // üî• UPDATED: Submit Order (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Firestore) üî•
    submitOrderBtn.addEventListener('click', () => {
        const orderTotal = currentOrder.reduce((sum, item) => sum + item.price * item.quantity, 0);

        if (currentOrder.length > 0) {
            const address = deliveryAddressInput.value.trim();
            const isPickup = address === '';
            
            if (isPickup) {
                 if (!confirm("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô '‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) { return; }
            }

            db.collection("orders").add({
                items: currentOrder,
                total: orderTotal,
                address: address || '‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô',
                status: '‡∏Ñ‡∏¥‡∏ß',
                placedAt: firebase.firestore.FieldValue.serverTimestamp(), // ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å Server
            })
            .then(docRef => {
                lastCommittedOrder = {
                     id: docRef.id, 
                     items: [...currentOrder],
                     total: orderTotal,
                     address: address || '‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô',
                };
                
                currentOrder = []; 
                deliveryAddressInput.value = '';
                renderCurrentOrder(); 
                showPaymentQRModal(orderTotal);
            })
            .catch(error => {
                console.error("Error adding document: ", error);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
            });
        }
    });

    // üî• UPDATED: renderOrderQueue (‡πÉ‡∏ä‡πâ Order ID ‡∏à‡∏≤‡∏Å Firestore) üî•
    function renderOrderQueue() {
        if (orderQueue.length === 0) {
            orderQueueEl.innerHTML = '<p class="text-gray-400 text-center mt-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß</p>';
            return;
        }
        const activeQueue = orderQueue.filter(order => order.status !== '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' && order.status !== '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');

        orderQueueEl.innerHTML = '';
        (activeQueue.length > 0 ? activeQueue : orderQueue).forEach(order => {
            const itemsSummary = order.items.map(item => `${item.name} (${item.size}, ‡∏´‡∏ß‡∏≤‡∏ô ${item.sweetness}) x${item.quantity}`).join(', ');
            const statusColor = {
                '‡∏Ñ‡∏¥‡∏ß': 'bg-blue-100 text-blue-800',
                '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥': 'bg-yellow-100 text-yellow-800',
                '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß': 'bg-green-100 text-green-800',
                '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å': 'bg-red-100 text-red-800'
            }[order.status];
            
            const orderCard = document.createElement('div');
            orderCard.className = `p-4 rounded-lg shadow-sm ${order.status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' || order.status === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ? 'bg-gray-200 opacity-75' : 'bg-gray-50 hover:bg-white'}`;
            orderCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h4 class="font-bold text-lg">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå #${order.id.substring(0, 8)}...</h4> 
                        <p class="text-sm text-gray-600">${itemsSummary}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <span class="font-semibold">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</span> ${order.address}
                        </p>
                    </div>
                    <span class="text-lg font-bold text-teal-600">‡∏ø${order.total.toLocaleString('th-TH')}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-semibold px-2.5 py-0.5 rounded-full ${statusColor}">${order.status}</span>
                    <div class="flex gap-2">
                        ${order.status === '‡∏Ñ‡∏¥‡∏ß' ? `<button class="text-xs bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1 px-3 rounded-lg" onclick="updateOrderStatus('${order.id}', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥')">‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>` : ''}
                        ${order.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥' ? `<button class="text-xs bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg" onclick="updateOrderStatus('${order.id}', '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß')">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>` : ''}
                        ${order.status !== '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' && order.status !== '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' ? `<button class="text-xs bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg" onclick="updateOrderStatus('${order.id}', '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>` : ''}
                    </div>
                </div>
            `;
            orderQueueEl.appendChild(orderCard);
        });
    }

    // üî• UPDATED: updateOrderStatus (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Firestore ‡πÅ‡∏•‡∏∞ Batch Write) üî•
    function updateOrderStatus(orderId, newStatus) {
        const order = orderQueue.find(o => o.id === orderId);
        if (!order) return;

        const updateData = { status: newStatus };
        if (newStatus === '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') {
            updateData.completedAt = firebase.firestore.FieldValue.serverTimestamp();
            
            const batch = db.batch(); 
            order.items.forEach(item => {
                const newLogRef = db.collection("salesLog").doc();
                batch.set(newLogRef, {
                    name: item.name,
                    size: item.size,
                    sweetness: item.sweetness,
                    quantity: item.quantity,
                    price: item.price,
                    soldAt: updateData.completedAt,
                    orderId: orderId
                });
            });
            batch.commit().then(() => {
                console.log("Sales Log batch successfully written!");
            }).catch((error) => {
                console.error("Error writing sales log batch: ", error);
            });
        }
        
        db.collection("orders").doc(orderId).update(updateData)
            .then(() => console.log("Order status updated!"))
            .catch(error => console.error("Error updating order: ", error));
    }

    // üî• UPDATED: updateSalesDashboard (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firestore Timestamp) üî•
    function updateSalesDashboard() {
        let salesToday = 0;
        let salesWeek = 0;
        let salesMonth = 0;
        
        menuSalesLog.forEach(log => {
             // ‡πÅ‡∏õ‡∏•‡∏á Firebase Timestamp ‡πÄ‡∏õ‡πá‡∏ô Date Object
            const saleDate = log.soldAt ? new Date(log.soldAt.seconds * 1000) : new Date();
            
            const totalRevenue = log.price * log.quantity;

            if (isToday(saleDate)) { salesToday += totalRevenue; }
            if (isThisWeek(saleDate)) { salesWeek += totalRevenue; }
            if (isThisMonth(saleDate)) { salesMonth += totalRevenue; }
        });
        
        salesTodayEl.textContent = `‡∏ø${salesToday.toLocaleString('th-TH')}`;
        salesWeekEl.textContent = `‡∏ø${salesWeek.toLocaleString('th-TH')}`;
        salesMonthEl.textContent = `‡∏ø${salesMonth.toLocaleString('th-TH')}`;
    }

    // üî• UPDATED: showMenuReport (‡πÉ‡∏ä‡πâ menuSalesLog ‡∏à‡∏≤‡∏Å Listener) üî•
    function showMenuReport() {
        const menuSales = {};
        
        menuSalesLog.forEach(log => {
            const key = `${log.name} (${log.size}, ‡∏´‡∏ß‡∏≤‡∏ô ${log.sweetness})`;
            if (!menuSales[key]) {
                menuSales[key] = { name: log.name, size: log.size, sweetness: log.sweetness, totalQuantity: 0, totalRevenue: 0, };
            }
            menuSales[key].totalQuantity += log.quantity;
            menuSales[key].totalRevenue += log.price * log.quantity;
        });
        
        // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
        const sortedMenuReport = Object.values(menuSales).sort((a, b) => b.totalQuantity - a.totalQuantity);
        let tableHTML = '<p class="text-gray-500 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡∏ß‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>';
        if (sortedMenuReport.length === 0) {
            tableHTML += '<p class="text-center text-gray-400 mt-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</p>';
        } else {
            tableHTML += `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-teal-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏°‡∏ô‡∏π / ‡∏Ç‡∏ô‡∏≤‡∏î / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÅ‡∏Å‡πâ‡∏ß)</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏° (‡∏ø)</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            sortedMenuReport.forEach( (report, index) => {
                tableHTML += `<tr class="${index < 3 ? 'bg-yellow-50 font-semibold' : ''}"><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${report.name} (${report.size}, ‡∏´‡∏ß‡∏≤‡∏ô ${report.sweetness})</td><td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">${report.totalQuantity.toLocaleString('th-TH')}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-right text-teal-600">${report.totalRevenue.toLocaleString('th-TH')}</td></tr>`;
            });
            tableHTML += '</tbody></table>';
        }
        menuReportContent.innerHTML = tableHTML;
        menuReportModal.classList.remove('hidden');
    }
    
    // --- Initial setup ---
    renderMenu();
    renderCurrentOrder();
    initFirebaseListeners(); // ‡πÄ‡∏£‡∏¥‡πà‡∏° Listener
</script>
